x-common-env: &common-env
  CELERY_BROKER_URL: redis://redis:6379/0
  CELERY_RESULT_BACKEND: redis://redis:6379/0
  REDIS_URL: redis://redis:6379/0
  FIRECRAWL_URL: http://host.docker.internal:3002
  EMBEDDING_URL: http://192.168.5.96:8000
  RERANK_URL: http://192.168.5.173:8001
  LLM_BASE_URL: http://192.168.6.19:8002/v1
  LLM_MODEL_NAME: nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16
  DATA_DIR: /app/data
  LOG_LEVEL: DEBUG
  # Phoenix observability
  PHOENIX_HOST: phoenix
  PHOENIX_PORT: "6006"

x-common-volumes: &common-volumes
  - ./src:/app/src
  - ./media:/app/media
  - ./data:/app/data
  - ./waywo.yml:/app/waywo.yml:ro
  - /app/.venv

x-common-depends: &common-depends
  depends_on:
    redis:
      condition: service_healthy

x-common-networks: &common-networks
  networks:
    - waywo-network

services:
  redis:
    image: redis/redis-stack:latest
    container_name: waywo-redis-stack
    ports:
      - "7379:6379"
      - "7001:8001"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - waywo-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Database migrations - runs once before other services start
  migrate:
    build: .
    container_name: waywo-migrate
    environment:
      <<: *common-env
    volumes: *common-volumes
    command: /app/.venv/bin/python -m src.db.migrate
    networks:
      - waywo-network
    restart: "no"

  backend:
    build: .
    container_name: waywo-backend
    ports:
      - "8008:8000"
    environment:
      <<: *common-env
    volumes: *common-volumes
    command: /app/.venv/bin/python -m uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - waywo-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "/app/.venv/bin/python", "/app/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  celery-worker:
    build: .
    container_name: waywo-celery-worker
    environment:
      <<: *common-env
    volumes: *common-volumes
    command: /app/.venv/bin/watchmedo auto-restart --directory=/app/src --pattern=*.py --recursive -- /app/.venv/bin/celery -A src.worker.app worker --loglevel=info --queues=waywo --concurrency=1
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - waywo-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test:
        [
          "CMD",
          "/app/.venv/bin/python",
          "/app/src/worker/healthcheck.py",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  celery-beat:
    build: .
    container_name: waywo-celery-beat
    environment:
      <<: *common-env
    volumes:
      - ./src:/app/src
      - ./media:/app/media
      - ./data:/app/data
      - ./waywo.yml:/app/waywo.yml:ro
      - /app/.venv
      - celery-beat-data:/app/celery-data
    command: /app/.venv/bin/watchmedo auto-restart --directory=/app/src --pattern=*.py --recursive -- /app/.venv/bin/celery -A src.worker.app beat --loglevel=info
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - waywo-network
    healthcheck:
      test:
        ["CMD", "/app/.venv/bin/python", "/app/src/worker/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Flower monitoring
  flower:
    image: mher/flower:2.0.1
    container_name: waywo-flower
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - FLOWER_PORT=5555
      - FLOWER_BROKER_API=redis://redis:6379/0
      - FLOWER_RESULT_BACKEND=redis://redis:6379/0
      - FLOWER_BROKER_API_REDIS_HOST=redis
      - FLOWER_BROKER_API_REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - waywo-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:5555/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: waywo-phoenix
    ports:
      - "6006:6006" # UI and OTLP HTTP collector
      - "4317:4317" # OTLP gRPC collector
    networks:
      - waywo-network
    restart: unless-stopped

  jupyter:
    build: .
    container_name: waywo-jupyter
    ports:
      - "8888:8888"
    environment:
      <<: *common-env
    volumes:
      - ./src:/app/src
      - ./media:/app/media
      - ./data:/app/data
      - ./notebooks:/app/notebooks
      - ./waywo.yml:/app/waywo.yml:ro
      - /app/.venv
    command: /app/.venv/bin/python -m jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --NotebookApp.token='' --NotebookApp.password='' --notebook-dir=/app/notebooks --allow-root
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - waywo-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

networks:
  waywo-network:
    driver: bridge

volumes:
  redis-data:
  celery-beat-data:
