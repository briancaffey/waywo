---
title: Testing
description: Running and writing tests for the waywo backend using pytest and pytest-asyncio.
navigation.icon: i-lucide-test-tubes
---

# Testing

## Test Stack

| Tool | Role |
|------|------|
| pytest | Test runner |
| pytest-asyncio | Async test support |
| pytest-cov | Coverage reporting |
| fakeredis | In-memory Redis mock |
| unittest.mock | Patching external services |

All test dependencies are included in the `[dev]` optional group:

```bash
pip install -e ".[dev]"
```

## Running Tests

```bash
# Run all tests with verbose output
pytest

# Run with coverage report
pytest --cov=src --cov-report=term-missing

# Run a specific test file
pytest src/test/test_data_collection.py

# Run tests matching a keyword
pytest -k "test_process_waywo_post"

# Run tests by marker
pytest -m pipeline
pytest -m api
pytest -m integration
```

### Using the Makefile

There is no dedicated `make test` target. Use `pytest` directly from the project root.

The Makefile provides formatting commands that are useful before committing:

```bash
make black   # Format code with Black (runs inside Docker)
make check   # Check formatting without modifying files
```

## Test Configuration

Test settings are defined in `pyproject.toml`:

```toml
[tool.pytest.ini_options]
testpaths = ["src/test"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = ["-v", "--tb=short", "--strict-markers", "--disable-warnings"]
markers = [
    "pipeline: pipeline functionality tests",
    "api: API and web server tests",
    "integration: end-to-end workflow tests",
]
```

## Test Fixtures

Shared fixtures are defined in `src/test/conftest.py`:

### `mock_redis`

Provides a `fakeredis.FakeRedis` instance and patches `src.redis_client.get_redis_client` so all Redis operations use the in-memory fake.

```python
def test_save_and_get_post(self, mock_redis, sample_post_data):
    post = WaywoPost(**sample_post_data, year=2025, month=12)
    save_post(post)
    retrieved = get_post(12345)
    assert retrieved is not None
```

### `sample_post_data` / `sample_comment_data`

Return dictionaries matching the shape of HN API responses, ready to construct `WaywoPost` or `WaywoComment` instances.

### `mock_hn_api`

Patches `src.tasks.fetch_item` with a lookup dictionary so tests can exercise post-processing logic without hitting the real HN API.

## Test Organization

Tests are grouped into classes by domain:

| Class | What it covers |
|-------|---------------|
| `TestModels` | Pydantic model construction from raw HN data |
| `TestRedisClient` | Key generation, save/retrieve round-trips, missing key handling |
| `TestTasks` | Celery task logic -- success, comment limits, skip-existing, not-found |
| `TestLoadWaywoYaml` | Loading and parsing `waywo.yml` |

## Coverage Configuration

Coverage settings in `pyproject.toml` exclude test files, virtual environments, and common boilerplate:

```toml
[tool.coverage.run]
source = ["src"]
omit = ["*/test/*", "*/__pycache__/*", "*/venv/*", "*/.venv/*"]

[tool.coverage.report]
show_missing = true
precision = 2
```

## Writing New Tests

1. Create a new file in `src/test/` following the `test_*.py` naming convention.
2. Use existing fixtures from `conftest.py` -- request `mock_redis` if your code touches Redis.
3. Group related tests into a `class Test*` for clarity.
4. For async tests, use `@pytest.mark.asyncio` and `async def test_*` functions.
5. Mock external services (HN API, embedding service, LLM) rather than calling them in tests.
