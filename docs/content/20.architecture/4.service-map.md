---
title: Service Map
description: Docker Compose service topology â€” every container, port mapping, purpose, and health check in the Waywo stack.
navigation.icon: i-lucide-network
---

# Service Map

Waywo runs as a Docker Compose stack with 9 containerized services plus 2 external GPU services. All containers communicate over the `waywo-network` bridge network.

## Docker Compose Services

| Service | Container Name | Port (host:container) | Purpose | Health Check |
|---|---|---|---|---|
| **redis** | `waywo-redis-stack` | `7379:6379`, `7001:8001` | Message broker (Celery), result backend, RedisInsight UI on 8001 | `redis-cli ping` |
| **migrate** | `waywo-migrate` | -- | Runs SQLAlchemy `create_all` + vector index init, then exits | -- (run-once) |
| **backend** | `waywo-backend` | `8008:8000` | FastAPI application server (Uvicorn with hot reload) | Python `healthcheck.py` script |
| **celery-worker** | `waywo-celery-worker` | -- | Celery worker processing the `waywo` queue (concurrency=1) | Python `celery_worker_healthcheck.py` |
| **celery-beat** | `waywo-celery-beat` | -- | Celery Beat scheduler for periodic tasks | Python `celery_beat_healthcheck.py` |
| **flower** | `waywo-flower` | `5555:5555` | Celery task monitoring web UI | `wget --spider http://localhost:5555/` |
| **nat** | `waywo-nat` | `8080:8080` | NAT (NVIDIA Agent Toolkit) service for LLM orchestration | `curl -f http://localhost:8080/health` |
| **phoenix** | `waywo-phoenix` | `6006:6006`, `4317:4317` | Arize Phoenix -- OpenTelemetry trace UI and OTLP collectors | -- |
| **jupyter** | `waywo-jupyter` | `8888:8888` | Jupyter Lab environment for interactive notebooks | -- |

## External GPU Services

These services run outside the Docker Compose stack on machines with GPU access. Their URLs are configured via environment variables.

| Service | Env Variable | Default URL | Model | Purpose |
|---|---|---|---|---|
| **LLM** | `LLM_BASE_URL` | `http://192.168.6.19:8002/v1` | NVIDIA-Nemotron-3-Nano-30B-A3B-BF16 | Text generation (OpenAI-compatible API) |
| **Embedding** | `EMBEDDING_URL` | `http://192.168.5.96:8000` | llama-embed-nemotron-8b | 4096-dim vector embeddings |
| **Rerank** | `RERANK_URL` | `http://192.168.5.173:8111` | llama-nemotron-rerank-1b-v2 | Cross-encoder document reranking |

## Startup Order

Services start in a dependency-aware order enforced by `depends_on` conditions:

```
redis (healthy)
    |
    +--> migrate (completed_successfully)
    |        |
    |        +--> backend
    |        |
    |        +--> celery-worker
    |        |        |
    |        |        +--> flower
    |        |
    |        +--> celery-beat
    |        |
    |        +--> jupyter
    |
    +--> nat
    |
    +--> phoenix (no dependency)
```

1. **Redis** starts first and must pass its health check (`redis-cli ping`)
2. **migrate** runs the database schema creation and vector index initialization, then exits
3. **backend**, **celery-worker**, **celery-beat**, and **jupyter** all wait for both Redis (healthy) and migrate (completed)
4. **flower** additionally waits for celery-worker to be healthy
5. **nat** and **phoenix** only depend on Redis

## Shared Configuration

All Python services share a common environment block defined via a YAML anchor (`x-common-env`):

| Variable | Value | Purpose |
|---|---|---|
| `CELERY_BROKER_URL` | `redis://redis:6379/0` | Celery message broker |
| `CELERY_RESULT_BACKEND` | `redis://redis:6379/0` | Celery result storage |
| `REDIS_URL` | `redis://redis:6379/0` | General Redis access |
| `NAT_SERVICE_URL` | `http://nat:8080` | NAT service endpoint |
| `FIRECRAWL_URL` | `http://host.docker.internal:3002` | URL scraping service |
| `EMBEDDING_URL` | `http://192.168.5.96:8000` | Embedding model endpoint |
| `RERANK_URL` | `http://192.168.5.173:8111` | Rerank model endpoint |
| `LLM_BASE_URL` | `http://192.168.6.19:8002/v1` | LLM endpoint (OpenAI-compatible) |
| `LLM_MODEL_NAME` | `nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16` | Model identifier |
| `DATA_DIR` | `/app/data` | SQLite database directory |
| `LOG_LEVEL` | `DEBUG` | Application log level |
| `PHOENIX_HOST` | `phoenix` | Phoenix tracing host |
| `PHOENIX_PORT` | `6006` | Phoenix tracing port |

## Volumes

| Volume | Type | Mounted To | Purpose |
|---|---|---|---|
| `./src` | Bind mount | `/app/src` | Python source code (hot reload) |
| `./media` | Bind mount | `/app/media` | Media file storage |
| `./data` | Bind mount | `/app/data` | SQLite database file (`waywo.db`) |
| `./waywo.yml` | Bind mount (ro) | `/app/waywo.yml` | HN post ID configuration |
| `redis-data` | Named volume | `/data` | Redis persistence |
| `celery-beat-data` | Named volume | `/app/celery-data` | Celery Beat schedule state |

::note
The `/app/.venv` path is excluded from bind mounts (mounted as an anonymous volume) so that the container's virtual environment is not overwritten by the host filesystem.
::

## Network

All services join a single `waywo-network` bridge network. Services that need to reach the host machine (for Firecrawl or other host-local services) include the `extra_hosts` mapping:

```yaml
extra_hosts:
  - "host.docker.internal:host-gateway"
```

This applies to **backend**, **celery-worker**, **nat**, and **jupyter**.
