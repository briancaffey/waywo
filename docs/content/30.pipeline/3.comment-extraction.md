---
title: Comment Extraction
description: How top-level HN comments are fetched from each post, stored in the database, and tracked for processing status.
navigation.icon: i-lucide-message-square
---

# Comment Extraction

The second pipeline stage fetches top-level comments from each collected post. In the context of "What are you working on?" threads, each top-level comment represents a single person's project submission.

## Why Only Top-Level Comments

HN threads have nested reply trees, but WAYWO only cares about the `kids` array on the post itself -- these are the direct replies where people describe what they are building. Nested replies (discussions, follow-up questions) are ignored because they do not contain new project submissions.

## Fetching Comments

During the `process_waywo_post` task, after the post is saved, the pipeline iterates through the post's `kids` array:

```python
kids = post.kids or []
if limit_comments is not None:
    kids = kids[:limit_comments]

for comment_id in kids:
    if comment_exists(comment_id):
        comments_skipped += 1
        continue

    comment_data = fetch_item(comment_id)
    if comment_data is None:
        continue

    comment = WaywoComment(**comment_data)
    save_comment(comment)
    comments_saved += 1
```

Key behaviors:

- **Deduplication** -- `comment_exists()` checks the database first; already-stored comments are skipped
- **Graceful failure** -- If `fetch_item()` returns `None` (network error, deleted item), the comment is silently skipped
- **Rate limiting** -- The `limit_comments` parameter allows capping how many comments to fetch per post, useful during testing

## Comment Model

Comments are stored as `WaywoComment` records:

```python
class WaywoComment(HNItem):
    parent: Optional[int] = None  # The parent post ID
```

The base `HNItem` provides common fields:

| Field     | Type          | Description                              |
|-----------|---------------|------------------------------------------|
| `id`      | int           | HN comment ID                            |
| `type`    | str           | Always `"comment"`                       |
| `by`      | str or None   | Author username                          |
| `time`    | int or None   | Unix timestamp                           |
| `text`    | str or None   | Comment HTML body                        |
| `dead`    | bool or None  | Whether the comment is flagged dead      |
| `deleted` | bool or None  | Whether the comment has been deleted     |
| `kids`    | list or None  | Child comment IDs (not used by WAYWO)    |
| `parent`  | int or None   | Parent post ID (links back to WaywoPost) |

## Processing Status Tracking

Each stored comment has an `is_processed` flag in the database. This flag controls which comments still need to go through the project extraction workflow.

- **Unprocessed** -- Newly fetched comments start as unprocessed
- **Processed** -- After the workflow completes successfully, `mark_comment_processed(comment_id)` sets the flag

The `get_unprocessed_comments(limit=None)` function returns comments that have not yet been processed, used by the batch processing task.

## Batch vs. Individual Processing

Comments can be sent through the project workflow in two ways:

### Batch processing

`process_waywo_comments` fetches all unprocessed comments and queues an individual task for each:

```python
comments = get_unprocessed_comments(limit=limit)
for comment in comments:
    process_waywo_comment.delay(comment_id=comment.id)
```

Trigger via API:

```
POST /api/process-waywo-comments
Body: { "limit": 50 }
```

### Individual processing

`process_waywo_comment` processes a single comment by ID. It can also be triggered from the API for reprocessing a specific comment:

```
POST /api/waywo-comments/{comment_id}/process
```

When reprocessing, any existing projects for that comment are deleted first to ensure a clean slate.
