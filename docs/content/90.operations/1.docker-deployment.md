---
title: Docker Deployment
description: Docker Compose service topology, volume mounts, networking, environment variables, and common commands for running Waywo.
navigation.icon: i-lucide-container
---

# Docker Deployment

Waywo runs as a multi-container application orchestrated by Docker Compose. All services share a single bridge network and a common set of environment variables defined through YAML anchors.

## YAML Anchors

The compose file defines four reusable anchors to keep service definitions DRY:

| Anchor | Purpose |
|--------|---------|
| `x-common-env` | Shared environment variables (Redis, LLM, embedding URLs, etc.) |
| `x-common-volumes` | Standard volume mounts for src, media, data, and waywo.yml |
| `x-common-depends` | `depends_on: redis: condition: service_healthy` |
| `x-common-networks` | Attaches to `waywo-network` |

## Service List

| Service | Container Name | Ports (host:container) | Image / Build | Depends On |
|---------|---------------|------------------------|---------------|------------|
| **redis** | `waywo-redis-stack` | `7379:6379`, `7001:8001` | `redis/redis-stack:latest` | -- |
| **migrate** | `waywo-migrate` | -- | Build from `.` | -- |
| **backend** | `waywo-backend` | `8008:8000` | Build from `.` | redis (healthy), migrate (completed) |
| **celery-worker** | `waywo-celery-worker` | -- | Build from `.` | redis (healthy), migrate (completed) |
| **celery-beat** | `waywo-celery-beat` | -- | Build from `.` | redis (healthy), migrate (completed) |
| **flower** | `waywo-flower` | `5555:5555` | `mher/flower:2.0.1` | redis (healthy), celery-worker (healthy) |
| **nat** | `waywo-nat` | `8080:8080` | Build from `./nat` | redis (healthy) |
| **phoenix** | `waywo-phoenix` | `6006:6006`, `4317:4317` | `arizephoenix/phoenix:latest` | -- |
| **jupyter** | `waywo-jupyter` | `8888:8888` | Build from `.` | redis (healthy), migrate (completed) |

## Startup Order

The `migrate` service runs database migrations and exits. Other services that depend on it use `condition: service_completed_successfully` to wait until migrations finish before starting.

```
redis (healthy)
  └── migrate (runs once, exits)
        ├── backend
        ├── celery-worker
        │     └── flower (waits for worker healthy)
        ├── celery-beat
        └── jupyter
  └── nat
phoenix (independent)
```

## Volume Mounts

The `x-common-volumes` anchor mounts the following into each application container:

| Host Path | Container Path | Mode | Purpose |
|-----------|---------------|------|---------|
| `./src` | `/app/src` | read-write | Application source code (enables hot-reload) |
| `./media` | `/app/media` | read-write | Generated media files |
| `./data` | `/app/data` | read-write | SQLite database (`waywo.db`) |
| `./waywo.yml` | `/app/waywo.yml` | **read-only** | HN post ID configuration |
| -- | `/app/.venv` | anonymous | Prevents host venv from overwriting container venv |

celery-beat adds one extra named volume:

| Named Volume | Container Path | Purpose |
|-------------|---------------|---------|
| `celery-beat-data` | `/app/celery-data` | Persistent schedule state across restarts |

Jupyter adds `./notebooks:/app/notebooks` for notebook files.

### Named Volumes

| Volume | Used By |
|--------|---------|
| `redis-data` | redis -- persists Redis data across container restarts |
| `celery-beat-data` | celery-beat -- persists the beat schedule database |

## Network

All services attach to `waywo-network`, a Docker bridge network:

```yaml
networks:
  waywo-network:
    driver: bridge
```

Services that need to reach the host machine (for GPU servers, Firecrawl, etc.) include `extra_hosts`:

```yaml
extra_hosts:
  - "host.docker.internal:host-gateway"
```

This is configured on: backend, celery-worker, nat, and jupyter.

## Environment Variables

All variables defined in `x-common-env`:

| Variable | Default Value | Purpose |
|----------|--------------|---------|
| `CELERY_BROKER_URL` | `redis://redis:6379/0` | Redis connection for Celery task broker |
| `CELERY_RESULT_BACKEND` | `redis://redis:6379/0` | Redis connection for Celery result storage |
| `REDIS_URL` | `redis://redis:6379/0` | General Redis connection for the application |
| `NAT_SERVICE_URL` | `http://nat:8080` | Internal URL for the NAT service |
| `FIRECRAWL_URL` | `http://host.docker.internal:3002` | URL scraping service (runs on host) |
| `EMBEDDING_URL` | `http://192.168.5.96:8000` | Embedding model server (GPU) |
| `RERANK_URL` | `http://192.168.5.173:8111` | Rerank model server (GPU) |
| `LLM_BASE_URL` | `http://192.168.6.19:8002/v1` | LLM inference server (OpenAI-compatible) |
| `LLM_MODEL_NAME` | `nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16` | Model identifier for LLM calls |
| `DATA_DIR` | `/app/data` | Directory for SQLite database and data files |
| `LOG_LEVEL` | `DEBUG` | Application log verbosity |
| `PHOENIX_HOST` | `phoenix` | Hostname for Phoenix observability collector |
| `PHOENIX_PORT` | `6006` | Port for Phoenix OTLP collector |

The nat service uses its own environment block with `NVIDIA_API_KEY`, `REDIS_URL`, `LLM_BASE_URL`, and `LLM_MODEL_NAME` (sourced from shell environment or defaults).

## Common Commands

Start all services in detached mode:

```bash
docker compose up -d
```

Follow logs for a specific service:

```bash
docker compose logs -f backend
docker compose logs -f celery-worker
```

Stop all services and remove containers:

```bash
docker compose down
```

Rebuild images after code changes to dependencies (Dockerfile, requirements):

```bash
docker compose build
docker compose up -d
```

::note
Source code changes under `./src` are picked up automatically via volume mounts and hot-reload (uvicorn `--reload` for backend, `watchmedo auto-restart` for Celery workers). You do not need to rebuild for Python code changes.
::

View running containers and their health status:

```bash
docker compose ps
```

Restart a single service:

```bash
docker compose restart celery-worker
```
