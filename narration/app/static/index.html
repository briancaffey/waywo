<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <!-- Prevent flash of wrong theme -->
  <script>
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Narration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 800: '#1e293b', 900: '#0f172a' },
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 0.7s linear infinite; }
    [v-cloak] { display: none; }
    /* Drag styles */
    .drag-over { border-top: 2px solid #6366f1 !important; }
    .dragging { opacity: 0.35; }
    /* Smooth transitions */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    /* Custom audio player sizing */
    audio { height: 32px; }
    audio::-webkit-media-controls-panel { background: #f1f5f9; border-radius: 6px; }
    .dark audio::-webkit-media-controls-panel { background: #374151; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-full transition-colors">
  <div id="app" v-cloak>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <h1 class="text-lg font-bold text-gray-900 dark:text-gray-100 tracking-tight">Narration</h1>
          <span class="text-xs text-gray-400 dark:text-gray-500 hidden sm:inline">Voice generation studio</span>
        </div>

        <!-- Project switcher + dark mode toggle -->
        <div class="flex items-center gap-2">
          <select v-model="currentProjectId" @change="switchProject"
            class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none min-w-[180px]">
            <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
          </select>
          <button @click="showNewProject = !showNewProject"
            class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            :class="showNewProject ? 'bg-gray-100 dark:bg-gray-700' : ''">
            {{ showNewProject ? 'Cancel' : '+ New' }}
          </button>
          <button v-if="currentProjectId" @click="deleteProject"
            class="text-sm px-3 py-1.5 rounded-lg transition-colors"
            :class="confirmDeleteProject ? 'bg-red-500 text-white hover:bg-red-600' : 'border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 hover:border-red-300 dark:hover:border-red-700'">
            {{ confirmDeleteProject ? 'Confirm delete' : 'Delete' }}
          </button>
          <!-- Dark mode toggle -->
          <button @click="toggleDark" class="text-sm p-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" title="Toggle dark mode">
            <svg v-if="!darkMode" class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
            </svg>
            <svg v-else class="w-4 h-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 py-6">

      <!-- Status bar -->
      <div v-if="status" class="mb-4 flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium"
        :class="status.includes('failed') || status.includes('Failed') ? 'bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-800' : 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800'">
        <svg v-if="generating" class="w-4 h-4 spinner text-indigo-500" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" class="opacity-25"/>
          <path d="M12 2a10 10 0 019.95 9" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
        </svg>
        {{ status }}
      </div>

      <!-- New project form -->
      <div v-if="showNewProject" class="mb-4 flex gap-2">
        <input v-model="newProjectName" placeholder="Project name..."
          class="flex-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
          @keyup.enter="createProject">
        <button @click="createProject" :disabled="!newProjectName.trim()"
          class="text-sm px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-40 disabled:cursor-not-allowed transition-colors font-medium">
          Create Project
        </button>
      </div>

      <template v-if="currentProjectId">

        <!-- Summary bar -->
        <div v-if="segments.length" class="flex items-center gap-4 mb-3 text-xs text-gray-500 dark:text-gray-400">
          <span class="flex items-center gap-1">
            <span class="inline-block w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></span>
            {{ segments.length }} segments
          </span>
          <span class="flex items-center gap-1">
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
            {{ doneCount }} done
          </span>
          <span v-if="pendingCount" class="flex items-center gap-1">
            <span class="inline-block w-2 h-2 rounded-full bg-amber-400"></span>
            {{ pendingCount }} pending
          </span>
          <span class="font-medium text-gray-700 dark:text-gray-300">{{ totalDuration }}</span>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-wrap items-center gap-2 mb-4">
          <button @click="showImport = !showImport"
            class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            :class="showImport ? 'bg-gray-100 dark:bg-gray-700 border-gray-400 dark:border-gray-500' : ''">
            {{ showImport ? 'Cancel' : 'Import Script' }}
          </button>
          <button @click="showAddSegment = !showAddSegment" :disabled="generating"
            class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors disabled:opacity-40">
            {{ showAddSegment ? 'Cancel' : '+ Add Segment' }}
          </button>
          <button @click="generateAll" :disabled="generating || segments.length === 0"
            class="text-sm px-4 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-40 disabled:cursor-not-allowed transition-colors font-medium">
            {{ generating ? 'Generating...' : 'Generate All' }}
          </button>
          <button @click="exportAudio" :disabled="!hasAudio"
            class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors disabled:opacity-40">
            Export WAV
          </button>
          <button v-if="segments.length" @click="clearAllSegments" :disabled="generating"
            class="text-sm px-3 py-1.5 rounded-lg transition-colors"
            :class="confirmClear ? 'bg-red-500 text-white hover:bg-red-600' : 'border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 hover:border-red-300 dark:hover:border-red-700'">
            {{ confirmClear ? 'Confirm clear all' : 'Clear All' }}
          </button>
          <button @click="showVoices = !showVoices"
            class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            :class="showVoices ? 'bg-gray-100 dark:bg-gray-700 border-gray-400 dark:border-gray-500' : ''">
            {{ showVoices ? 'Hide Voices' : 'Voices' }}
          </button>
        </div>

        <!-- Voice samples panel -->
        <div v-if="showVoices" class="mb-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 shadow-sm">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Voice Samples (Dia)</h3>

          <!-- Existing samples -->
          <div v-if="voiceSamples.length" class="space-y-2 mb-3">
            <div v-for="vs in voiceSamples" :key="vs.id"
              class="flex items-center gap-2 py-1.5 px-2 rounded-lg border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300 min-w-[80px]">{{ vs.name }}</span>
              <span class="text-xs text-gray-400 dark:text-gray-500 truncate flex-1" :title="vs.transcript">{{ vs.transcript || 'No transcript' }}</span>
              <audio :src="'/api/voice-samples/' + vs.id + '/audio'" controls preload="none" class="max-w-[150px]" style="height:28px;"></audio>
              <button @click="deleteVoiceSample(vs.id)"
                class="text-xs px-1.5 py-0.5 rounded transition-colors"
                :class="confirmDeleteVs === vs.id ? 'bg-red-500 text-white' : 'border border-gray-200 dark:border-gray-600 text-gray-400 hover:text-red-500 dark:hover:text-red-400 hover:border-red-300 dark:hover:border-red-700'">
                {{ confirmDeleteVs === vs.id ? 'Sure?' : '\u00d7' }}
              </button>
            </div>
          </div>
          <div v-else class="text-xs text-gray-400 dark:text-gray-500 mb-3">No voice samples yet.</div>

          <!-- Upload form -->
          <div class="flex flex-wrap items-end gap-2 pt-2 border-t border-gray-100 dark:border-gray-700">
            <div class="flex flex-col gap-1">
              <label class="text-xs text-gray-500 dark:text-gray-400">Name</label>
              <input v-model="vsName" placeholder="Voice name..."
                class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-2.5 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none w-32">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-xs text-gray-500 dark:text-gray-400">Transcript</label>
              <input v-model="vsTranscript" placeholder="Reference text..."
                class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-2.5 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none w-64">
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-xs text-gray-500 dark:text-gray-400">WAV File</label>
              <input type="file" accept=".wav" ref="vsFileInput"
                class="text-sm text-gray-500 dark:text-gray-400 file:mr-2 file:py-1 file:px-2.5 file:rounded-md file:border file:border-gray-300 dark:file:border-gray-600 file:text-xs file:bg-white dark:file:bg-gray-700 dark:file:text-gray-300 file:cursor-pointer">
            </div>
            <button @click="uploadVoiceSample" :disabled="!vsName.trim()"
              class="text-sm px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-40 transition-colors font-medium">
              Upload
            </button>
          </div>

          <!-- Magpie voices -->
          <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
            <div class="flex items-center gap-2 mb-2">
              <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Magpie Voices</h3>
              <button @click="fetchMagpieVoices" class="text-xs px-2 py-0.5 rounded border border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Refresh</button>
            </div>
            <div v-if="magpieVoices.length" class="flex flex-wrap gap-1.5">
              <span v-for="v in magpieVoices" :key="v" class="text-xs px-2 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">{{ v }}</span>
            </div>
            <div v-else class="text-xs text-gray-400 dark:text-gray-500">Click Refresh to load available voices from Magpie.</div>
          </div>
        </div>

        <!-- Import panel -->
        <div v-if="showImport" class="mb-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 shadow-sm">
          <textarea v-model="importText" placeholder="Paste script here (one line per segment)..."
            class="w-full text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 font-mono bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-y min-h-[120px]"></textarea>
          <div class="flex items-center gap-2 mt-3">
            <select v-model="importService"
              class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 outline-none">
              <option value="dia">Dia (voice clone)</option>
              <option value="magpie">Magpie (fast)</option>
            </select>
            <button @click="doImport" :disabled="!importText.trim()"
              class="text-sm px-4 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-40 transition-colors font-medium">
              Import
            </button>
          </div>
        </div>

        <!-- Add segment inline -->
        <div v-if="showAddSegment" class="mb-4 flex gap-2">
          <input v-model="addText" placeholder="Enter segment text..."
            class="flex-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
            @keyup.enter="addSegment">
          <button @click="addSegment" :disabled="!addText.trim()"
            class="text-sm px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-40 transition-colors font-medium">
            Add
          </button>
        </div>

        <!-- Segments list -->
        <div v-if="segments.length" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
          <div v-for="(seg, idx) in segments" :key="seg.id">
            <div
              class="flex items-start gap-2 sm:gap-3 px-3 sm:px-4 py-3 transition-colors group"
              :class="[
                idx < segments.length - 1 ? 'border-b border-gray-100 dark:border-gray-700' : '',
                dragOverId === seg.id ? 'drag-over' : '',
                dragId === seg.id ? 'dragging' : '',
                'hover:bg-gray-50/70 dark:hover:bg-gray-700/50'
              ]"
              draggable="true"
              @dragstart="onDragStart($event, seg)"
              @dragover.prevent="onDragOver(seg)"
              @dragleave="dragOverId = null"
              @drop.prevent="onDrop(seg)"
              @dragend="onDragEnd"
            >
              <!-- Handle + number -->
              <div class="flex items-center gap-1 pt-0.5 shrink-0">
                <span class="cursor-grab active:cursor-grabbing text-gray-300 dark:text-gray-600 hover:text-gray-500 dark:hover:text-gray-400 transition-colors select-none text-sm" title="Drag to reorder">&#x2630;</span>
                <span class="w-6 text-center text-xs font-bold text-gray-400 dark:text-gray-500">{{ seg.position }}</span>
              </div>

              <!-- Body -->
              <div class="flex-1 min-w-0">
                <template v-if="editing === seg.id">
                  <div class="flex gap-2">
                    <input v-model="editText"
                      class="flex-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-2.5 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                      @keyup.enter="saveEdit(seg.id)" @keyup.escape="editing = null">
                    <button @click="saveEdit(seg.id)" class="text-xs px-2.5 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">Save</button>
                    <button @click="editing = null" class="text-xs px-2.5 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                  </div>
                </template>
                <template v-else>
                  <p class="text-sm leading-relaxed cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors" @click="startEdit(seg)">{{ seg.text }}</p>
                </template>
              </div>

              <!-- Controls -->
              <div class="flex items-center gap-1.5 shrink-0 flex-wrap justify-end">
                <select v-model="seg.service" @change="updateService(seg)"
                  class="text-xs border border-gray-200 dark:border-gray-600 rounded-md px-1.5 py-1 bg-white dark:bg-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 outline-none">
                  <option value="dia">dia</option>
                  <option value="magpie">magpie</option>
                </select>

                <select v-if="seg.service === 'dia' && voiceSamples.length" v-model="seg.voice_sample_id" @change="updateVoice(seg)"
                  class="text-xs border border-gray-200 dark:border-gray-600 rounded-md px-1.5 py-1 bg-white dark:bg-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 outline-none max-w-[100px]">
                  <option :value="null">default</option>
                  <option v-for="vs in voiceSamples" :key="vs.id" :value="vs.id">{{ vs.name }}</option>
                </select>

                <select v-if="seg.service === 'magpie' && magpieVoices.length" v-model="seg.magpie_voice" @change="updateVoice(seg)"
                  class="text-xs border border-gray-200 dark:border-gray-600 rounded-md px-1.5 py-1 bg-white dark:bg-gray-700 dark:text-gray-200 focus:ring-1 focus:ring-indigo-500 outline-none max-w-[140px]"
                  :title="seg.magpie_voice || 'default'">
                  <option :value="null">default</option>
                  <option v-for="v in magpieVoices" :key="v" :value="v">{{ v.split('.').pop() }}</option>
                </select>

                <span class="text-xs px-1.5 py-0.5 rounded-md font-medium"
                  :class="{
                    'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400': seg.status === 'pending',
                    'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-400': seg.status === 'generating',
                    'bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-400': seg.status === 'done',
                    'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-400': seg.status === 'error',
                  }">{{ seg.status }}</span>

                <span class="text-xs text-gray-400 dark:text-gray-500 w-8 text-right tabular-nums">{{ seg.duration_seconds ? fmtDuration(seg.duration_seconds) : '\u2014' }}</span>

                <audio v-if="seg.status === 'done'" :src="'/api/segments/' + seg.id + '/audio'" controls preload="none" class="max-w-[180px]"></audio>

                <button v-if="!generating" @click="generateOne(seg.id)" title="Generate"
                  class="text-xs px-2 py-1 rounded-md border border-indigo-200 dark:border-indigo-700 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors">Gen</button>

                <button v-if="seg.status === 'done' && !generating" @click="toggleVariants(seg.id)"
                  class="text-xs px-2 py-1 rounded-md border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                  {{ expandedVariants === seg.id ? 'Hide' : 'Variants' }}
                </button>

                <button @click="deleteSegment(seg.id)"
                  class="text-xs px-2 py-1 rounded-md transition-colors"
                  :class="confirmDeleteSeg === seg.id ? 'bg-red-500 text-white' : 'border border-gray-200 dark:border-gray-600 text-gray-400 hover:text-red-500 dark:hover:text-red-400 hover:border-red-300 dark:hover:border-red-700 hover:bg-red-50 dark:hover:bg-red-900/30'">
                  {{ confirmDeleteSeg === seg.id ? 'Sure?' : '\u00d7' }}
                </button>
              </div>
            </div>

            <!-- Variants panel -->
            <div v-if="expandedVariants === seg.id" class="px-4 py-3 bg-gray-50 dark:bg-gray-900/50 border-b border-gray-100 dark:border-gray-700">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Variants</h4>
                <span class="text-xs text-gray-400 dark:text-gray-500">({{ (variantsMap[seg.id] || []).length }})</span>
              </div>

              <div v-if="!(variantsMap[seg.id] || []).length" class="text-xs text-gray-400 dark:text-gray-500 py-1">
                No variants yet. Generate or regenerate to create variants.
              </div>

              <div v-for="v in (variantsMap[seg.id] || [])" :key="v.id"
                class="flex items-center gap-2 py-1.5 border-b border-gray-200 dark:border-gray-700 last:border-0"
                :class="seg.selected_variant_id === v.id ? 'font-medium' : ''">
                <span v-if="seg.selected_variant_id === v.id"
                  class="text-[10px] px-1.5 py-0.5 bg-indigo-500 text-white rounded font-medium uppercase">active</span>
                <span class="flex-1 text-xs text-gray-500 dark:text-gray-400 truncate" :title="v.text">{{ v.service }} &middot; {{ fmtDuration(v.duration_seconds) }} &middot; {{ v.text }}</span>
                <audio :src="'/api/variants/' + v.id + '/audio'" controls preload="none" class="max-w-[150px]" style="height:28px;"></audio>
                <button v-if="seg.selected_variant_id !== v.id" @click="selectVariant(seg.id, v.id)"
                  class="text-[11px] px-2 py-0.5 rounded border border-indigo-200 dark:border-indigo-700 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors">Use</button>
                <button @click="deleteVariantBtn(seg.id, v.id)"
                  class="text-[11px] px-1.5 py-0.5 rounded transition-colors"
                  :class="confirmDeleteVar === v.id ? 'bg-red-500 text-white' : 'border border-gray-200 dark:border-gray-600 text-gray-400 hover:text-red-500 dark:hover:text-red-400 hover:border-red-300 dark:hover:border-red-700'">
                  {{ confirmDeleteVar === v.id ? 'Sure?' : '\u00d7' }}
                </button>
              </div>

              <!-- Regenerate -->
              <div class="flex gap-2 mt-2">
                <input v-model="regenText[seg.id]" :placeholder="seg.text"
                  class="flex-1 text-xs border border-gray-300 dark:border-gray-600 rounded-lg px-2.5 py-1.5 bg-white dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                  @keyup.enter="regenerate(seg.id)">
                <button @click="regenerate(seg.id)" :disabled="generating"
                  class="text-xs px-3 py-1.5 rounded-lg border border-indigo-200 dark:border-indigo-700 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 disabled:opacity-40 transition-colors font-medium">
                  Regenerate
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div v-else class="text-center py-16">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 mb-4">
            <svg class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z"/>
            </svg>
          </div>
          <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">No segments yet</p>
          <p class="text-gray-400 dark:text-gray-500 text-xs">Import a script or add segments manually to get started.</p>
        </div>

      </template>

      <!-- No project state -->
      <div v-else class="text-center py-20">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-indigo-50 dark:bg-indigo-900/30 mb-5">
          <svg class="w-10 h-10 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v6m3-3H9m4.06-7.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
          </svg>
        </div>
        <p class="text-gray-600 dark:text-gray-300 font-medium mb-1">Create a project to get started</p>
        <p class="text-gray-400 dark:text-gray-500 text-sm">Each project holds its own script, segments, and generated audio.</p>
      </div>

    </main>
  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    createApp({
      setup() {
        const darkMode = ref(document.documentElement.classList.contains('dark'));

        function toggleDark() {
          darkMode.value = !darkMode.value;
          document.documentElement.classList.toggle('dark', darkMode.value);
          localStorage.setItem('theme', darkMode.value ? 'dark' : 'light');
        }

        const projects = ref([]);
        const currentProjectId = ref(null);
        const showNewProject = ref(false);
        const newProjectName = ref('');
        const confirmDeleteProject = ref(false);

        const segments = ref([]);
        const showImport = ref(false);
        const importText = ref('');
        const importService = ref('dia');
        const editing = ref(null);
        const editText = ref('');
        const generating = ref(false);
        const status = ref('');
        const expandedVariants = ref(null);
        const variantsMap = reactive({});
        const regenText = reactive({});
        const showAddSegment = ref(false);
        const addText = ref('');
        const confirmDeleteSeg = ref(null);
        const confirmDeleteVar = ref(null);
        const confirmClear = ref(false);
        const dragId = ref(null);
        const dragOverId = ref(null);

        // Voice samples
        const showVoices = ref(false);
        const voiceSamples = ref([]);
        const magpieVoices = ref([]);
        const vsName = ref('');
        const vsTranscript = ref('');
        const vsFileInput = ref(null);
        const confirmDeleteVs = ref(null);

        const hasAudio = computed(() => segments.value.some(s => s.status === 'done'));
        const doneCount = computed(() => segments.value.filter(s => s.status === 'done').length);
        const pendingCount = computed(() => segments.value.filter(s => s.status !== 'done').length);
        const totalDuration = computed(() => {
          const total = segments.value.reduce((sum, s) => sum + (s.duration_seconds || 0), 0);
          return fmtDuration(total);
        });

        function fmtDuration(sec) {
          if (!sec) return '0:00';
          const m = Math.floor(sec / 60);
          const s = Math.floor(sec % 60);
          return `${m}:${s.toString().padStart(2, '0')}`;
        }

        async function fetchProjects() {
          const res = await fetch('/api/projects');
          projects.value = await res.json();
        }

        async function createProjectFn() {
          if (!newProjectName.value.trim()) return;
          const res = await fetch('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newProjectName.value.trim() }),
          });
          const proj = await res.json();
          newProjectName.value = '';
          showNewProject.value = false;
          await fetchProjects();
          currentProjectId.value = proj.id;
          await fetchSegments();
        }

        async function switchProject() {
          expandedVariants.value = null;
          await fetchSegments();
        }

        async function deleteProject() {
          if (!confirmDeleteProject.value) {
            confirmDeleteProject.value = true;
            setTimeout(() => confirmDeleteProject.value = false, 3000);
            return;
          }
          confirmDeleteProject.value = false;
          await fetch(`/api/projects/${currentProjectId.value}`, { method: 'DELETE' });
          await fetchProjects();
          currentProjectId.value = projects.value.length ? projects.value[0].id : null;
          if (currentProjectId.value) await fetchSegments();
          else segments.value = [];
        }

        async function fetchSegments() {
          if (!currentProjectId.value) { segments.value = []; return; }
          const res = await fetch(`/api/projects/${currentProjectId.value}/segments`);
          segments.value = await res.json();
        }

        async function fetchVariants(segId) {
          const res = await fetch(`/api/segments/${segId}/variants`);
          variantsMap[segId] = await res.json();
        }

        async function toggleVariants(segId) {
          if (expandedVariants.value === segId) { expandedVariants.value = null; }
          else { expandedVariants.value = segId; await fetchVariants(segId); }
        }

        async function doImport() {
          if (!importText.value.trim()) return;
          await fetch(`/api/projects/${currentProjectId.value}/segments/import`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: importText.value, service: importService.value }),
          });
          showImport.value = false;
          importText.value = '';
          expandedVariants.value = null;
          await fetchSegments();
        }

        async function addSegment() {
          if (!addText.value.trim()) return;
          await fetch(`/api/projects/${currentProjectId.value}/segments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: addText.value.trim() }),
          });
          addText.value = '';
          showAddSegment.value = false;
          await fetchSegments();
        }

        function startEdit(seg) { editing.value = seg.id; editText.value = seg.text; }

        async function saveEdit(id) {
          if (!editText.value.trim()) return;
          await fetch(`/api/segments/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: editText.value }),
          });
          editing.value = null;
          await fetchSegments();
        }

        async function updateService(seg) {
          await fetch(`/api/segments/${seg.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ service: seg.service }),
          });
        }

        async function deleteSegment(id) {
          if (confirmDeleteSeg.value !== id) {
            confirmDeleteSeg.value = id;
            setTimeout(() => { if (confirmDeleteSeg.value === id) confirmDeleteSeg.value = null; }, 2000);
            return;
          }
          confirmDeleteSeg.value = null;
          await fetch(`/api/segments/${id}`, { method: 'DELETE' });
          if (expandedVariants.value === id) expandedVariants.value = null;
          await fetchSegments();
        }

        async function clearAllSegments() {
          if (!confirmClear.value) {
            confirmClear.value = true;
            setTimeout(() => confirmClear.value = false, 3000);
            return;
          }
          confirmClear.value = false;
          await fetch(`/api/projects/${currentProjectId.value}/segments`, { method: 'DELETE' });
          expandedVariants.value = null;
          await fetchSegments();
        }

        async function generateOne(id) {
          generating.value = true;
          const seg = segments.value.find(s => s.id === id);
          status.value = `Generating segment ${seg ? seg.position : id}...`;
          try {
            const res = await fetch(`/api/segments/${id}/generate`, { method: 'POST' });
            if (!res.ok) { const err = await res.json(); status.value = err.detail || 'Generation failed'; }
            else { status.value = ''; }
          } finally {
            generating.value = false;
            await fetchSegments();
            if (expandedVariants.value === id) await fetchVariants(id);
          }
        }

        async function generateAll() {
          generating.value = true;
          const pending = segments.value.filter(s => s.status !== 'done');
          for (let i = 0; i < pending.length; i++) {
            status.value = `Generating segment ${pending[i].position} (${i + 1}/${pending.length})...`;
            try {
              const res = await fetch(`/api/segments/${pending[i].id}/generate`, { method: 'POST' });
              if (!res.ok) { const err = await res.json(); console.error(`Segment ${pending[i].id} failed:`, err); }
            } catch (e) { console.error(`Segment ${pending[i].id} error:`, e); }
            await fetchSegments();
          }
          generating.value = false;
          status.value = '';
        }

        async function regenerate(segId) {
          generating.value = true;
          const seg = segments.value.find(s => s.id === segId);
          status.value = `Regenerating segment ${seg ? seg.position : segId}...`;
          const textOverride = regenText[segId]?.trim() || null;
          try {
            const body = textOverride ? { text: textOverride } : {};
            const res = await fetch(`/api/segments/${segId}/regenerate`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            if (!res.ok) { const err = await res.json(); status.value = err.detail || 'Regeneration failed'; }
            else { status.value = ''; }
          } finally {
            generating.value = false;
            regenText[segId] = '';
            await fetchSegments();
            await fetchVariants(segId);
          }
        }

        async function selectVariant(segId, variantId) {
          await fetch(`/api/segments/${segId}/variants/${variantId}/select`, { method: 'POST' });
          await fetchSegments();
          await fetchVariants(segId);
        }

        async function deleteVariantBtn(segId, variantId) {
          if (confirmDeleteVar.value !== variantId) {
            confirmDeleteVar.value = variantId;
            setTimeout(() => { if (confirmDeleteVar.value === variantId) confirmDeleteVar.value = null; }, 2000);
            return;
          }
          confirmDeleteVar.value = null;
          await fetch(`/api/variants/${variantId}`, { method: 'DELETE' });
          await fetchSegments();
          await fetchVariants(segId);
        }

        async function exportAudio() {
          window.location.href = `/api/projects/${currentProjectId.value}/export`;
        }

        // Voice samples
        async function fetchVoiceSamples() {
          const res = await fetch('/api/voice-samples');
          voiceSamples.value = await res.json();
        }

        async function fetchMagpieVoices() {
          try {
            const res = await fetch('/api/voices');
            const data = await res.json();
            magpieVoices.value = data.voices || [];
          } catch (e) { console.error('Failed to fetch Magpie voices:', e); }
        }

        async function uploadVoiceSample() {
          if (!vsName.value.trim()) return;
          const fileEl = vsFileInput.value;
          if (!fileEl || !fileEl.files || !fileEl.files[0]) { status.value = 'Please select a WAV file'; return; }
          const formData = new FormData();
          formData.append('name', vsName.value.trim());
          formData.append('transcript', vsTranscript.value.trim());
          formData.append('audio', fileEl.files[0]);
          const res = await fetch('/api/voice-samples', { method: 'POST', body: formData });
          if (!res.ok) { const err = await res.json(); status.value = err.detail || 'Upload failed'; return; }
          vsName.value = '';
          vsTranscript.value = '';
          fileEl.value = '';
          await fetchVoiceSamples();
        }

        async function deleteVoiceSample(id) {
          if (confirmDeleteVs.value !== id) {
            confirmDeleteVs.value = id;
            setTimeout(() => { if (confirmDeleteVs.value === id) confirmDeleteVs.value = null; }, 2000);
            return;
          }
          confirmDeleteVs.value = null;
          await fetch(`/api/voice-samples/${id}`, { method: 'DELETE' });
          await fetchVoiceSamples();
        }

        async function updateVoice(seg) {
          const body = {};
          if (seg.service === 'dia') body.voice_sample_id = seg.voice_sample_id || 0;
          if (seg.service === 'magpie') body.magpie_voice = seg.magpie_voice || '';
          await fetch(`/api/segments/${seg.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
        }

        function onDragStart(e, seg) { dragId.value = seg.id; e.dataTransfer.effectAllowed = 'move'; }
        function onDragOver(seg) { if (dragId.value !== seg.id) dragOverId.value = seg.id; }
        function onDragEnd() { dragId.value = null; dragOverId.value = null; }
        async function onDrop(targetSeg) {
          dragOverId.value = null;
          if (!dragId.value || dragId.value === targetSeg.id) return;
          const ordered = [...segments.value].sort((a, b) => a.position - b.position);
          const srcIdx = ordered.findIndex(s => s.id === dragId.value);
          const dstIdx = ordered.findIndex(s => s.id === targetSeg.id);
          const [moved] = ordered.splice(srcIdx, 1);
          ordered.splice(dstIdx, 0, moved);
          const ordering = ordered.map((s, i) => ({ id: s.id, position: i + 1 }));
          await fetch('/api/segments/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ordering }),
          });
          dragId.value = null;
          await fetchSegments();
        }

        onMounted(async () => {
          await fetchProjects();
          await fetchVoiceSamples();
          if (projects.value.length) {
            currentProjectId.value = projects.value[0].id;
            await fetchSegments();
          }
        });

        return {
          darkMode, toggleDark,
          projects, currentProjectId, showNewProject, newProjectName, confirmDeleteProject,
          segments, showImport, importText, importService,
          editing, editText, generating, status,
          expandedVariants, variantsMap, regenText,
          showAddSegment, addText, confirmDeleteSeg, confirmDeleteVar, confirmClear,
          dragId, dragOverId,
          showVoices, voiceSamples, magpieVoices, vsName, vsTranscript, vsFileInput, confirmDeleteVs,
          hasAudio, doneCount, pendingCount, totalDuration,
          fmtDuration, fetchProjects, createProject: createProjectFn, switchProject, deleteProject,
          fetchSegments, doImport, addSegment,
          startEdit, saveEdit, updateService, updateVoice, deleteSegment, clearAllSegments,
          generateOne, generateAll, regenerate,
          selectVariant, deleteVariantBtn, toggleVariants,
          exportAudio,
          fetchVoiceSamples, fetchMagpieVoices, uploadVoiceSample, deleteVoiceSample,
          onDragStart, onDragOver, onDragEnd, onDrop,
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
